<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Notifica√ß√µes - Frontend</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 30px; }
        .status { 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 4px; 
            overflow-x: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .notification-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .notification-item h3 { margin: 0 0 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Teste de Notifica√ß√µes - Frontend Debug</h1>
        <p>Este teste simula o que a p√°gina /notifications est√° fazendo</p>
        
        <button onclick="testUserAuth()">1. Verificar Autentica√ß√£o</button>
        <button onclick="testAPIEndpoint()">2. Testar API Diretamente</button>
        <button onclick="testFrontendLogic()">3. Simular L√≥gica do Frontend</button>
        <button onclick="clearAll()">Limpar</button>
    </div>

    <div id="results"></div>

    <script>
        const API_BASE = 'https://7care.netlify.app';
        
        function addResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = 'container';
            div.innerHTML = `
                <h2>${title}</h2>
                <div class="status ${type}">${content}</div>
            `;
            results.appendChild(div);
        }
        
        function addJSON(title, data) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = 'container';
            div.innerHTML = `
                <h2>${title}</h2>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }
        
        function clearAll() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function testUserAuth() {
            addResult('Teste 1: Verificando Autentica√ß√£o', 'Testando...', 'info');
            
            try {
                // Tentar buscar usu√°rios (endpoint p√∫blico/autenticado)
                const response = await fetch(`${API_BASE}/api/users`);
                const data = await response.json();
                
                if (data.users || Array.isArray(data)) {
                    const users = data.users || data;
                    const filipe = users.find(u => 
                        u.name?.toLowerCase().includes('filipe') || 
                        u.email?.toLowerCase().includes('filipe')
                    );
                    
                    if (filipe) {
                        addResult('‚úÖ Usu√°rio Encontrado', 
                            `ID: ${filipe.id}<br>
                             Nome: ${filipe.name}<br>
                             Email: ${filipe.email}<br>
                             Role: ${filipe.role}`, 
                            'success'
                        );
                        window.filipeId = filipe.id;
                    } else {
                        addResult('‚ùå Usu√°rio N√£o Encontrado', 
                            'Filipe Peixoto n√£o est√° na lista de usu√°rios', 
                            'error'
                        );
                    }
                    addJSON('Primeiros 5 usu√°rios:', users.slice(0, 5));
                } else {
                    addResult('‚ùå Erro na API', 'Resposta inesperada da API', 'error');
                    addJSON('Resposta completa:', data);
                }
            } catch (error) {
                addResult('‚ùå Erro de Rede', error.message, 'error');
            }
        }
        
        async function testAPIEndpoint() {
            if (!window.filipeId) {
                addResult('‚ö†Ô∏è Execute o Teste 1 Primeiro', 
                    'Preciso do ID do usu√°rio para continuar', 
                    'error'
                );
                return;
            }
            
            addResult('Teste 2: Testando API Diretamente', 
                `Buscando notifica√ß√µes do user_id ${window.filipeId}...`, 
                'info'
            );
            
            try {
                // Teste com endpoint de debug
                const debugResponse = await fetch(`${API_BASE}/api/debug/notifications?userId=${window.filipeId}`);
                const debugData = await debugResponse.json();
                
                addResult('‚úÖ Endpoint de Debug', 
                    `Status: ${debugResponse.status}<br>
                     Total de notifica√ß√µes: ${debugData.count || 0}`, 
                    debugData.count > 0 ? 'success' : 'error'
                );
                
                if (debugData.count > 0) {
                    addJSON('Notifica√ß√µes (Debug):', debugData.notifications);
                }
                
                // Teste com endpoint real usado pela p√°gina
                const realResponse = await fetch(`${API_BASE}/api/notifications/${window.filipeId}?limit=50`);
                const realData = await realResponse.json();
                
                addResult('‚úÖ Endpoint Real (/api/notifications/:userId)', 
                    `Status: ${realResponse.status}<br>
                     Total de notifica√ß√µes: ${Array.isArray(realData) ? realData.length : 0}`, 
                    Array.isArray(realData) && realData.length > 0 ? 'success' : 'error'
                );
                
                if (Array.isArray(realData) && realData.length > 0) {
                    addJSON('Notifica√ß√µes (Real):', realData);
                    window.notifications = realData;
                } else {
                    addResult('‚ùå Nenhuma Notifica√ß√£o Retornada', 
                        'A API n√£o retornou notifica√ß√µes', 
                        'error'
                    );
                    addJSON('Resposta completa:', realData);
                }
            } catch (error) {
                addResult('‚ùå Erro ao Buscar Notifica√ß√µes', error.message, 'error');
            }
        }
        
        async function testFrontendLogic() {
            if (!window.notifications || window.notifications.length === 0) {
                addResult('‚ö†Ô∏è Execute o Teste 2 Primeiro', 
                    'Preciso das notifica√ß√µes da API para continuar', 
                    'error'
                );
                return;
            }
            
            addResult('Teste 3: Simulando L√≥gica do Frontend', 
                'Convertendo formato do BD para interface...', 
                'info'
            );
            
            try {
                // Simular a l√≥gica do NotificationsHistory.tsx
                const formattedNotifications = window.notifications.map((notif) => ({
                    id: notif.id.toString(),
                    title: notif.title,
                    message: notif.message,
                    type: notif.type,
                    hasAudio: false,
                    hasImage: false,
                    timestamp: notif.created_at || notif.createdAt,
                    read: notif.is_read || notif.isRead || false
                }));
                
                addResult('‚úÖ Formata√ß√£o Conclu√≠da', 
                    `${formattedNotifications.length} notifica√ß√µes formatadas com sucesso`, 
                    'success'
                );
                
                addJSON('Notifica√ß√µes Formatadas:', formattedNotifications);
                
                // Renderizar notifica√ß√µes
                const results = document.getElementById('results');
                const div = document.createElement('div');
                div.className = 'container';
                div.innerHTML = '<h2>üìã Notifica√ß√µes Renderizadas (como apareceriam na p√°gina)</h2>';
                
                formattedNotifications.forEach(notif => {
                    const notifDiv = document.createElement('div');
                    notifDiv.className = 'notification-item';
                    notifDiv.innerHTML = `
                        <h3>${notif.title}</h3>
                        <p>${notif.message}</p>
                        <small>
                            Tipo: ${notif.type} | 
                            ID: ${notif.id} | 
                            ${new Date(notif.timestamp).toLocaleString('pt-BR')}
                        </small>
                    `;
                    div.appendChild(notifDiv);
                });
                
                results.appendChild(div);
                
            } catch (error) {
                addResult('‚ùå Erro na Formata√ß√£o', error.message, 'error');
            }
        }
        
        // Auto-executar teste 1 ao carregar
        window.onload = () => {
            addResult('‚ÑπÔ∏è Instru√ß√µes', 
                'Este teste vai verificar:<br>1. Se conseguimos autenticar e buscar o usu√°rio<br>2. Se a API retorna notifica√ß√µes<br>3. Se a formata√ß√£o est√° correta<br><br>Clique nos bot√µes na ordem para diagnosticar o problema.', 
                'info'
            );
        };
    </script>
</body>
</html>

