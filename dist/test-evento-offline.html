<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste: Criar Evento Offline</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-top: 0; }
        h2 { color: #666; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #5568d3; }
        .log { 
            background: #f8f9fa; 
            padding: 10px; 
            margin: 5px 0;
            border-left: 3px solid #667eea;
            font-family: monospace;
            font-size: 12px;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        input, select { 
            width: 100%; 
            padding: 8px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            border-radius: 4px;
        }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>
    <div class="card">
        <h1>üß™ Teste: Criar Evento Offline e Ver Aparecer</h1>
        <p><strong>Este teste vai:</strong></p>
        <ol>
            <li>Verificar se SW v28 est√° ativo</li>
            <li>Simular cria√ß√£o de evento offline</li>
            <li>Verificar se foi salvo no IndexedDB</li>
            <li>Verificar se aparece ao buscar eventos</li>
        </ol>
    </div>

    <div class="card">
        <h2>1Ô∏è‚É£ Verificar Service Worker</h2>
        <button onclick="checkSW()">Verificar SW v28</button>
        <div id="sw-status"></div>
    </div>

    <div class="card">
        <h2>2Ô∏è‚É£ Criar Evento Offline (Simula√ß√£o)</h2>
        <div class="grid">
            <div>
                <label>T√≠tulo:</label>
                <input type="text" id="eventTitle" value="Evento Teste Offline" />
            </div>
            <div>
                <label>Tipo:</label>
                <select id="eventType">
                    <option value="Reuni√£o">Reuni√£o</option>
                    <option value="Culto">Culto</option>
                    <option value="Estudo">Estudo</option>
                </select>
            </div>
        </div>
        <label>Local:</label>
        <input type="text" id="eventLocation" value="Igreja Central" />
        <label>Data/Hora:</label>
        <input type="datetime-local" id="eventDate" />
        <br><br>
        <button onclick="createEventOffline()">üìù Simular POST /api/events (Offline)</button>
        <div id="create-status"></div>
    </div>

    <div class="card">
        <h2>3Ô∏è‚É£ Verificar IndexedDB</h2>
        <button onclick="checkIndexedDB()">Verificar Dados Salvos</button>
        <div id="db-status"></div>
    </div>

    <div class="card">
        <h2>4Ô∏è‚É£ Buscar Eventos (GET) com Mesclagem</h2>
        <button onclick="getEvents()">üì• GET /api/events (deve mesclar locais + cache)</button>
        <div id="get-status"></div>
    </div>

    <div class="card">
        <h2>5Ô∏è‚É£ Sincronizar</h2>
        <button onclick="syncNow()">üîÑ For√ßar Sincroniza√ß√£o</button>
        <div id="sync-status"></div>
    </div>

    <script>
        // Definir data/hora padr√£o para amanh√£ √†s 19:00
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(19, 0, 0, 0);
        document.getElementById('eventDate').value = tomorrow.toISOString().slice(0, 16);
        
        function addLog(containerId, message, type = 'log') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = \`log \${type}\`;
            div.textContent = message;
            container.appendChild(div);
            console.log(message);
        }
        
        async function checkSW() {
            const container = document.getElementById('sw-status');
            container.innerHTML = '';
            
            try {
                const reg = await navigator.serviceWorker.getRegistration();
                if (!reg) {
                    addLog('sw-status', '‚ùå Nenhum Service Worker registrado', 'error');
                    return;
                }
                
                addLog('sw-status', \`‚úÖ Service Worker registrado\`, 'success');
                addLog('sw-status', \`   Ativo: \${!!reg.active}\`, reg.active ? 'success' : 'error');
                addLog('sw-status', \`   Controlador: \${!!navigator.serviceWorker.controller}\`, navigator.serviceWorker.controller ? 'success' : 'error');
                
                // Verificar caches
                const caches = await window.caches.keys();
                const hasV28 = caches.some(c => c.includes('v28'));
                addLog('sw-status', \`   Cache v28: \${hasV28}\`, hasV28 ? 'success' : 'error');
                addLog('sw-status', \`   Caches: \${caches.join(', ')}\`, 'log');
                
            } catch (error) {
                addLog('sw-status', \`‚ùå Erro: \${error.message}\`, 'error');
            }
        }
        
        async function createEventOffline() {
            const container = document.getElementById('create-status');
            container.innerHTML = '';
            
            const eventData = {
                title: document.getElementById('eventTitle').value,
                type: document.getElementById('eventType').value,
                location: document.getElementById('eventLocation').value,
                date: document.getElementById('eventDate').value,
                description: 'Evento criado offline via teste'
            };
            
            addLog('create-status', 'üìù Tentando criar evento...', 'log');
            addLog('create-status', \`Dados: \${JSON.stringify(eventData, null, 2)}\`, 'log');
            
            try {
                const response = await fetch('/api/events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventData)
                });
                
                const result = await response.json();
                
                addLog('create-status', \`Status: \${response.status}\`, response.ok ? 'success' : 'error');
                addLog('create-status', \`Headers:\`, 'log');
                addLog('create-status', \`   X-Offline-Created: \${response.headers.get('X-Offline-Created')}\`, 'log');
                addLog('create-status', \`   X-Pending-Sync: \${response.headers.get('X-Pending-Sync')}\`, 'log');
                
                addLog('create-status', \`Resposta:\`, 'log');
                addLog('create-status', \`   ID: \${result.id}\`, 'log');
                addLog('create-status', \`   _tempId: \${result._tempId}\`, 'log');
                addLog('create-status', \`   _pendingSync: \${result._pendingSync}\`, 'log');
                addLog('create-status', \`   _offlineCreated: \${result._offlineCreated}\`, 'log');
                
                if (result._offlineCreated) {
                    addLog('create-status', '‚úÖ Evento criado OFFLINE com sucesso!', 'success');
                    addLog('create-status', 'üíæ Agora verificando IndexedDB...', 'log');
                    setTimeout(checkIndexedDB, 1000);
                } else {
                    addLog('create-status', '‚úÖ Evento criado ONLINE no servidor', 'success');
                }
                
            } catch (error) {
                addLog('create-status', \`‚ùå Erro: \${error.message}\`, 'error');
            }
        }
        
        async function checkIndexedDB() {
            const container = document.getElementById('db-status');
            container.innerHTML = '';
            
            try {
                const db = await new Promise((resolve, reject) => {
                    const req = indexedDB.open('7care-sync-db', 2);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
                
                addLog('db-status', \`‚úÖ Database: \${db.name} v\${db.version}\`, 'success');
                addLog('db-status', \`Stores: \${Array.from(db.objectStoreNames).join(', ')}\`, 'log');
                
                // Verificar sync-queue
                if (db.objectStoreNames.contains('sync-queue')) {
                    const queueTx = db.transaction(['sync-queue'], 'readonly');
                    const queueStore = queueTx.objectStore('sync-queue');
                    const queueReq = queueStore.getAll();
                    const queueItems = await new Promise(r => { queueReq.onsuccess = () => r(queueReq.result); });
                    
                    addLog('db-status', \`üìã Sync Queue: \${queueItems.length} itens\`, queueItems.length > 0 ? 'success' : 'log');
                    if (queueItems.length > 0) {
                        const last = queueItems[queueItems.length - 1];
                        addLog('db-status', \`   √öltimo: \${last.method} \${last.url}\`, 'log');
                    }
                }
                
                // Verificar local-data
                if (db.objectStoreNames.contains('local-data')) {
                    const dataTx = db.transaction(['local-data'], 'readonly');
                    const dataStore = dataTx.objectStore('local-data');
                    const dataReq = dataStore.getAll();
                    const dataItems = await new Promise(r => { dataReq.onsuccess = () => r(dataReq.result); });
                    
                    addLog('db-status', \`üíæ Local Data: \${dataItems.length} itens\`, dataItems.length > 0 ? 'success' : 'warning');
                    if (dataItems.length > 0) {
                        dataItems.forEach((item, idx) => {
                            addLog('db-status', \`   \${idx + 1}. \${item.data.title} (ID: \${item.id})\`, 'log');
                        });
                    } else {
                        addLog('db-status', '‚ö†Ô∏è Local Data VAZIO - Evento n√£o foi salvo!', 'error');
                        addLog('db-status', 'üí° Isso significa que o SW n√£o est√° salvando os dados locais', 'warning');
                    }
                } else {
                    addLog('db-status', '‚ùå Store "local-data" N√ÉO EXISTE!', 'error');
                    addLog('db-status', 'üí° O SW v28 n√£o criou o store corretamente', 'error');
                }
                
            } catch (error) {
                addLog('db-status', \`‚ùå Erro: \${error.message}\`, 'error');
            }
        }
        
        async function getEvents() {
            const container = document.getElementById('get-status');
            container.innerHTML = '';
            
            addLog('get-status', 'üì• Buscando eventos (GET /api/events)...', 'log');
            
            try {
                const response = await fetch('/api/events');
                const events = await response.json();
                
                addLog('get-status', \`Status: \${response.status}\`, 'success');
                addLog('get-status', \`Headers:\`, 'log');
                addLog('get-status', \`   X-Cached: \${response.headers.get('X-Cached')}\`, 'log');
                addLog('get-status', \`   X-Has-Local-Data: \${response.headers.get('X-Has-Local-Data')}\`, 'log');
                
                addLog('get-status', \`\\nüìã Total de eventos retornados: \${events.length}\`, 'success');
                
                // Verificar se tem eventos offline
                const offlineEvents = events.filter(e => e._pendingSync || e._offlineCreated);
                if (offlineEvents.length > 0) {
                    addLog('get-status', \`‚úÖ Eventos offline encontrados: \${offlineEvents.length}\`, 'success');
                    offlineEvents.forEach((evt, idx) => {
                        addLog('get-status', \`   \${idx + 1}. \${evt.title} (ID: \${evt.id}) üîÑ PENDENTE\`, 'warning');
                    });
                } else {
                    addLog('get-status', \`‚ö†Ô∏è Nenhum evento offline na lista\`, 'warning');
                    addLog('get-status', \`üí° A mesclagem n√£o est√° funcionando\`, 'error');
                }
                
                // Mostrar √∫ltimos 5 eventos
                addLog('get-status', \`\\nüìã √öltimos 5 eventos:\`, 'log');
                events.slice(0, 5).forEach((evt, idx) => {
                    const isPending = evt._pendingSync ? ' üîÑ' : '';
                    addLog('get-status', \`   \${idx + 1}. \${evt.title} (ID: \${evt.id})\${isPending}\`, 'log');
                });
                
            } catch (error) {
                addLog('get-status', \`‚ùå Erro: \${error.message}\`, 'error');
            }
        }
        
        async function syncNow() {
            const container = document.getElementById('sync-status');
            container.innerHTML = '';
            
            addLog('sync-status', 'üîÑ For√ßando sincroniza√ß√£o...', 'log');
            
            if (!navigator.serviceWorker.controller) {
                addLog('sync-status', '‚ùå Service Worker n√£o est√° ativo', 'error');
                return;
            }
            
            try {
                const messageChannel = new MessageChannel();
                
                messageChannel.port1.onmessage = (event) => {
                    addLog('sync-status', \`Resposta do SW: \${JSON.stringify(event.data)}\`, 'log');
                    
                    if (event.data.success && event.data.result) {
                        addLog('sync-status', \`‚úÖ Sincronizado: \${event.data.result.success} sucesso\`, 'success');
                        addLog('sync-status', \`‚ùå Falhas: \${event.data.result.failed}\`, event.data.result.failed > 0 ? 'error' : 'log');
                        
                        if (event.data.result.success > 0) {
                            addLog('sync-status', 'üéâ Recarregue a p√°gina para ver IDs reais', 'success');
                        }
                    }
                };
                
                navigator.serviceWorker.controller.postMessage(
                    { type: 'SYNC_NOW' },
                    [messageChannel.port2]
                );
                
                addLog('sync-status', 'üì§ Mensagem enviada ao SW...', 'log');
                
            } catch (error) {
                addLog('sync-status', \`‚ùå Erro: \${error.message}\`, 'error');
            }
        }
        
        // Auto-verificar SW ao carregar
        window.onload = () => {
            checkSW();
        };
    </script>
</body>
</html>

