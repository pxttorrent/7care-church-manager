const e={USERS:"users",EVENTS:"events",TASKS:"tasks",PRAYERS:"prayers",RELATIONSHIPS:"relationships",MEETINGS:"meetings",INTERESTED:"interested",DASHBOARD_STATS:"dashboard_stats",METADATA:"metadata"};async function t(t,o){const a=await new Promise((t,o)=>{const a=indexedDB.open("7care-offline-storage",1);a.onerror=()=>o(a.error),a.onsuccess=()=>t(a.result),a.onupgradeneeded=t=>{const o=t.target.result;Object.values(e).forEach(e=>{o.objectStoreNames.contains(e)||o.createObjectStore(e,{keyPath:"id",autoIncrement:!0})})}}),n=a.transaction(t,"readwrite").objectStore(t);await new Promise((e,t)=>{const o=n.clear();o.onsuccess=()=>e(void 0),o.onerror=()=>t(o.error)});for(const e of o)await new Promise((t,o)=>{const a=n.add(e);a.onsuccess=()=>t(void 0),a.onerror=()=>o(a.error)});a.close()}async function o(o){const a=[{name:"Usuários",endpoint:"/api/users",store:e.USERS},{name:"Eventos",endpoint:"/api/events",store:e.EVENTS},{name:"Tarefas",endpoint:"/api/tasks",store:e.TASKS},{name:"Orações",endpoint:"/api/prayers",store:e.PRAYERS},{name:"Relacionamentos",endpoint:"/api/relationships",store:e.RELATIONSHIPS},{name:"Reuniões",endpoint:"/api/meetings",store:e.MEETINGS},{name:"Interessados",endpoint:"/api/interested",store:e.INTERESTED},{name:"Dashboard",endpoint:"/api/dashboard/stats",store:e.DASHBOARD_STATS}],n=a.length;let s=0;for(const{name:e,endpoint:d,store:c}of a)try{o?.(Math.round(s/n*100),`Baixando ${e}...`);const a=await fetch(d,{credentials:"include"});if(!a.ok)throw new Error(`HTTP ${a.status}`);const r=await a.json(),i=Array.isArray(r)?r:[r];await t(c,i),s++}catch(i){s++}const r={id:1,downloadedAt:(new Date).toISOString(),version:1,totalItems:s};await t(e.METADATA,[r]),o?.(100,"Download concluído!"),localStorage.setItem("offline-data-downloaded","true"),localStorage.setItem("offline-data-downloaded-at",r.downloadedAt)}async function a(){if(!("estimate"in navigator.storage))return 0;try{return(await navigator.storage.estimate()).usage||0}catch{return 0}}export{o as downloadAllData,a as getStorageSize};
