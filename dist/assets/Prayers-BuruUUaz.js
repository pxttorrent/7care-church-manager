import{j as e}from"./ui-CM4P41nz.js";import{r as s}from"./vendor-v6ZOr5pf.js";import{f as a,g as r,k as i,M as t,I as o,e as n,C as d,c as l,a as c,b as m,B as u,i as x,d as p}from"./index-CwpLeuZK.js";import{A as h,a as f,b as g}from"./avatar-Te2cL-OZ.js";import{S as j}from"./search-Bab_JkLP.js";import{H as v}from"./heart-f_Goj_6w.js";import{T as N}from"./trash-2-BLa3_kJW.js";import"./charts-56rtB2he.js";const w={1:{emoji:"üçÉ",label:"Distante",color:"bg-red-100 text-red-800"},2:{emoji:"üîç",label:"Buscando",color:"bg-orange-100 text-orange-800"},3:{emoji:"üå±",label:"Enraizando",color:"bg-yellow-100 text-yellow-800"},4:{emoji:"üçÉ",label:"Frutificando",color:"bg-blue-100 text-blue-800"},5:{emoji:"‚ú®",label:"Intimidade",color:"bg-green-100 text-green-800"}},y=()=>{const{user:y}=a(),{toast:b}=r(),[C,P]=s.useState([]),[A,S]=s.useState([]),[E,I]=s.useState(""),[U,k]=s.useState("all"),[O,$]=s.useState(!0),[R,D]=s.useState({}),[_,T]=s.useState({}),B=e=>{if(e)return String(e).startsWith("http")?e:`/uploads/${e}`};s.useEffect(()=>{y?.id&&L()},[y]),s.useEffect(()=>{z()},[C,E,U]);const L=async()=>{try{if(!y?.id)return void b({title:"Usu√°rio n√£o identificado",description:"Por favor, fa√ßa login novamente.",variant:"destructive"});const e=`/api/prayers?userId=${y.id}&userRole=${y.role}&userChurch=${encodeURIComponent(y.church||"")}`,s=await fetch(e);if(s.ok){const e=(await s.json()).map(e=>({...e,userName:e.requester_name||"Usu√°rio",userChurch:e.church||"Igreja",userId:e.user_id,emotionalScore:0,isAnswered:e.is_answered||!1,isPrivate:e.is_private||!1,allowChurchMembers:e.allow_church_members||!0,createdAt:e.created_at,answeredAt:e.answered_at}));P(e),e.forEach(e=>{e.isAnswered||q(e.id)})}}catch(e){b({title:"Erro ao carregar ora√ß√µes",description:"N√£o foi poss√≠vel carregar os pedidos de ora√ß√£o.",variant:"destructive"})}finally{$(!1)}},z=()=>{let e=C;"pending"===U?e=e.filter(e=>!e.isAnswered):"answered"===U&&(e=e.filter(e=>e.isAnswered)),E&&(e=e.filter(e=>e.userName.toLowerCase().includes(E.toLowerCase())||e.prayerRequest?.toLowerCase().includes(E.toLowerCase()))),S(e)},q=async e=>{T(s=>({...s,[e]:!0}));try{const s=await fetch(`/api/prayers/${e}/intercessors`);if(s.ok){const a=(await s.json()).map(e=>({...e,intercessorName:e.intercessor_name||"Usu√°rio",intercessorProfilePhoto:e.profile_photo||null}));D(s=>({...s,[e]:a}))}}catch(s){}finally{T(s=>({...s,[e]:!1}))}},M=e=>"admin"===y?.role||(e.userId===parseInt(y?.id||"0")||!e.isPrivate&&!(!e.allowChurchMembers||e.userChurch!==y?.church)),V=e=>{if(!e)return"Data n√£o dispon√≠vel";try{const s=new Date(e);return isNaN(s.getTime())?"Data inv√°lida":s.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch(s){return"Data inv√°lida"}};if(O)return e.jsx(i,{children:e.jsxs("div",{className:"p-4 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{children:"Carregando ora√ß√µes..."})]})});const J=A.filter(M);return e.jsx(i,{children:e.jsxs("div",{className:"p-4 space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center justify-center gap-2",children:[e.jsx(t,{className:"h-6 w-6 text-blue-600"}),"Pedidos de Ora√ß√£o"]}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Compartilhe e acompanhe as necessidades da igreja"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(j,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(o,{placeholder:"Buscar por nome ou pedido...",value:E,onChange:e=>I(e.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(n,{variant:"all"===U?"default":"outline",size:"sm",onClick:()=>k("all"),children:["Todas (",J.length,")"]}),e.jsxs(n,{variant:"pending"===U?"default":"outline",size:"sm",onClick:()=>k("pending"),children:["Pendentes (",J.filter(e=>!e.isAnswered).length,")"]}),e.jsxs(n,{variant:"answered"===U?"default":"outline",size:"sm",onClick:()=>k("answered"),children:["Respondidas (",J.filter(e=>e.isAnswered).length,")"]})]})]}),e.jsx("div",{className:"space-y-4",children:0===J.length?e.jsx(d,{className:"text-center py-8",children:e.jsxs(l,{children:[e.jsx(t,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:E||"all"!==U?"Nenhuma ora√ß√£o encontrada com os filtros aplicados.":"Nenhum pedido de ora√ß√£o ainda."})]})}):J.map(s=>e.jsxs(d,{className:"overflow-hidden",children:[e.jsx(c,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(h,{className:"ring-2 ring-white shadow-md",style:{width:"52px",height:"52px"},children:[e.jsx(f,{src:B(s.userProfilePhoto),alt:`Foto de ${s.userName}`,className:"object-cover object-center w-full h-full",style:{imageRendering:"crisp-edges",filter:"contrast(1.1) brightness(1.05)"}}),e.jsx(g,{className:"bg-blue-100 text-blue-600 text-lg font-semibold",children:s.userName?.charAt(0)?.toUpperCase()||"U"})]}),e.jsxs("div",{children:[e.jsx(m,{className:"text-base",children:s.userName}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.userChurch})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{variant:s.isAnswered?"default":"secondary",className:s.isAnswered?"bg-green-100 text-green-800":"",children:s.isAnswered?"Respondida":"Pendente"}),s.isPrivate&&e.jsxs(u,{variant:"outline",className:"border-orange-200 text-orange-700",children:[e.jsx(x,{className:"h-3 w-3 mr-1"}),"Privada"]})]})]})}),e.jsxs(l,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-2xl",children:w[s.emotionalScore]?.emoji}),e.jsx(u,{className:w[s.emotionalScore]?.color,children:w[s.emotionalScore]?.label})]}),s.prayerRequest&&e.jsx("div",{className:"bg-gray-50 p-3 rounded-lg",children:e.jsx("p",{className:"text-sm text-gray-700",children:s.prayerRequest})}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{className:"h-3 w-3"}),V(s.createdAt)]}),s.isAnswered&&s.answeredBy&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("span",{children:["Respondida por ",s.answeredBy]}),s.answeredAt&&e.jsxs("span",{children:["em ",V(s.answeredAt)]})]})]}),!s.isAnswered&&s.userId!==parseInt(y?.id||"0")&&e.jsx("div",{className:"flex gap-2",children:e.jsxs(n,{onClick:()=>(async e=>{if(y?.id)try{C.find(s=>s.id===e)?.isUserPraying?(await fetch(`/api/prayers/${e}/intercessor/${y.id}`,{method:"DELETE"})).ok&&(P(s=>s.map(s=>s.id===e?{...s,isUserPraying:!1}:s)),q(e),b({title:"Sucesso",description:"Voc√™ n√£o est√° mais orando por este pedido"})):(await fetch(`/api/prayers/${e}/intercessor`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({intercessorId:y.id})})).ok&&(P(s=>s.map(s=>s.id===e?{...s,isUserPraying:!0}:s)),q(e),b({title:"Sucesso",description:"Voc√™ est√° orando por este pedido"}))}catch(s){b({title:"Erro",description:"Erro ao gerenciar intercessor",variant:"destructive"})}})(s.id),size:"sm",variant:s.isUserPraying?"default":"outline",className:"flex-1 "+(s.isUserPraying?"bg-blue-600 hover:bg-blue-700":"bg-green-50 hover:bg-green-100 text-green-700 border-green-200"),children:[e.jsx(v,{className:"h-4 w-4 mr-2"}),s.isUserPraying?"Voc√™ est√° orando por este pedido":"Orar por este pedido"]})}),!s.isAnswered&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Quem est√° orando:"}),_[s.id]&&e.jsx("span",{className:"text-xs text-gray-500",children:"Carregando..."})]}),R[s.id]&&R[s.id].length>0?e.jsx("div",{className:"flex flex-wrap gap-2",children:R[s.id].map(s=>e.jsxs("div",{className:"flex items-center gap-2 bg-blue-50 px-2 py-1 rounded-full",children:[e.jsxs(h,{className:"w-5 h-5",children:[e.jsx(f,{src:s.intercessorProfilePhoto}),e.jsx(g,{className:"bg-blue-100 text-blue-600 text-xs",children:s.intercessorName?.charAt(0)?.toUpperCase()||"U"})]}),e.jsx("span",{className:"text-xs text-blue-700",children:s.intercessorName})]},s.id))}):e.jsx("p",{className:"text-xs text-gray-500 italic",children:s.userId===parseInt(y?.id||"0")?"Ningu√©m est√° orando por este pedido ainda":"Seja o primeiro a orar por este pedido"})]}),e.jsxs("div",{className:"flex gap-2",children:[!s.isAnswered&&("admin"===y?.role||s.userId===parseInt(y?.id||"0"))&&e.jsxs(n,{onClick:()=>(async e=>{try{if(!y?.id)return void b({title:"Usu√°rio n√£o identificado",description:"Por favor, fa√ßa login novamente.",variant:"destructive"});(await fetch(`/api/prayers/${e}/answer`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({answeredBy:parseInt(y.id)})})).ok&&(P(s=>s.map(s=>s.id===e?{...s,isAnswered:!0,answeredAt:(new Date).toISOString(),answeredBy:y?.name}:s)),b({title:"Ora√ß√£o marcada como respondida",description:"O pedido foi marcado como atendido."}))}catch(s){b({title:"Erro ao marcar ora√ß√£o",description:"N√£o foi poss√≠vel marcar a ora√ß√£o como respondida.",variant:"destructive"})}})(s.id),size:"sm",className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(t,{className:"h-4 w-4 mr-2"}),"Marcar como Respondida"]}),("admin"===y?.role||s.userId===parseInt(y?.id||"0"))&&e.jsxs(n,{onClick:()=>(async e=>{try{if(!y?.id)return void b({title:"Usu√°rio n√£o identificado",description:"Por favor, fa√ßa login novamente.",variant:"destructive"});if(!C.find(s=>s.id===e))return void b({title:"Ora√ß√£o n√£o encontrada",description:"Esta ora√ß√£o j√° foi exclu√≠da ou n√£o existe mais.",variant:"destructive"});const s=await fetch(`/api/prayers/${e}?userId=${y.id}&userRole=${y.role}`,{method:"DELETE"});if(s.ok)P(s=>s.filter(s=>s.id!==e)),b({title:"Ora√ß√£o exclu√≠da",description:"O pedido de ora√ß√£o foi removido com sucesso."});else{const e=await s.json();b({title:"Erro ao excluir ora√ß√£o",description:e.error||"N√£o foi poss√≠vel excluir a ora√ß√£o.",variant:"destructive"})}}catch(s){b({title:"Erro ao excluir ora√ß√£o",description:"N√£o foi poss√≠vel excluir a ora√ß√£o.",variant:"destructive"})}})(s.id),size:"sm",variant:"destructive",className:"flex-1",disabled:!C.find(e=>e.id===s.id),title:C.find(e=>e.id===s.id)?"Excluir ora√ß√£o":"Ora√ß√£o j√° foi exclu√≠da",children:[e.jsx(N,{className:"h-4 w-4 mr-2"}),C.find(e=>e.id===s.id)?"Excluir":"J√° Exclu√≠da"]})]})]})]},s.id))})]})})};export{y as default};
