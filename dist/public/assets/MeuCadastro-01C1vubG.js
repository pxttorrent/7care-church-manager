import{j as e}from"./ui-D1vmdbY6.js";import{r as a}from"./vendor-Ber6wfih.js";import{c as s,f as t,h as r,X as i,i as l,j as n,o,C as c,d,a as h,b as m,L as u,y as x,I as v,O as p,J as j,e as f,k as g}from"./index-DtHhSAMi.js";import{D as w,a as N,b,c as y,d as C,e as P,f as S}from"./dialog-btQUui9q.js";import{L as k}from"./loader-circle-Cl-3bEuZ.js";import{U as F,S as D}from"./upload-v_97tXyL.js";import"./charts-leMEfCN9.js";
/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=s("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]),E=s("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]),O=s("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),T=({isOpen:s,onClose:l,onCapture:n,isLoading:o=!1})=>{const c=a.useRef(null),d=a.useRef(null),[h,m]=a.useState(null),[u,x]=a.useState(!1),[v,p]=a.useState(null),[j,f]=a.useState(null),[g,P]=a.useState(!1);a.useEffect(()=>{(()=>{const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);P(e)})()},[]),a.useEffect(()=>(s&&!v&&S(),()=>{F()}),[s,v]);const S=async()=>{try{f(null);const e={video:{facingMode:g?"environment":"user",width:{ideal:1280},height:{ideal:720}},audio:!1},a=await navigator.mediaDevices.getUserMedia(e);c.current&&(c.current.srcObject=a,c.current.play()),m(a),x(!0),f(!0)}catch(e){f(!1),x(!1)}},F=()=>{h&&(h.getTracks().forEach(e=>e.stop()),m(null),x(!1))},D=()=>{F(),p(null),l()};return e.jsx(w,{open:s,onOpenChange:D,children:e.jsxs(N,{className:"sm:max-w-lg p-0",children:[e.jsxs(b,{className:"p-4 pb-0",children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(z,{className:"h-5 w-5"}),"Tirar Foto"]}),e.jsx(C,{children:"Use os controles para tirar uma foto com sua câmera."})]}),e.jsxs("div",{className:"relative bg-black rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"relative aspect-[4/3] bg-black flex items-center justify-center",children:[null===j&&e.jsxs("div",{className:"text-white text-center p-4",children:[e.jsx(k,{className:"h-8 w-8 animate-spin mx-auto mb-2"}),e.jsx("p",{children:"Solicitando acesso à câmera..."})]}),!1===j&&e.jsxs("div",{className:"text-white text-center p-4",children:[e.jsx(z,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),e.jsx("p",{className:"mb-2",children:"Câmera não disponível"}),e.jsx("p",{className:"text-sm text-gray-300",children:"Verifique se você deu permissão para acessar a câmera"}),e.jsx(t,{variant:"outline",size:"sm",className:"mt-4",onClick:S,children:"Tentar Novamente"})]}),v?e.jsx("img",{src:v,alt:"Foto capturada",className:"w-full h-full object-cover"}):e.jsx("video",{ref:c,className:"w-full h-full object-cover",autoPlay:!0,playsInline:!0,muted:!0}),e.jsx("canvas",{ref:d,className:"hidden"})]}),j&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/80 to-transparent",children:e.jsx("div",{className:"flex items-center justify-center gap-4",children:v?e.jsxs(e.Fragment,{children:[e.jsxs(t,{variant:"outline",size:"lg",onClick:()=>{p(null),S()},className:"bg-white/20 border-white/30 text-white hover:bg-white/30",children:[e.jsx(O,{className:"h-5 w-5 mr-2"}),"Tirar Novamente"]}),e.jsx(t,{size:"lg",onClick:()=>{v&&d.current&&d.current.toBlob(e=>{if(e){const a=new File([e],`photo_${Date.now()}.jpg`,{type:"image/jpeg"});n(a),D()}},"image/jpeg",.8)},disabled:o,className:"bg-green-600 hover:bg-green-700 text-white",children:o?e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"h-5 w-5 mr-2 animate-spin"}),"Salvando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(r,{className:"h-5 w-5 mr-2"}),"Confirmar"]})})]}):e.jsxs(e.Fragment,{children:[g&&e.jsx(t,{variant:"outline",size:"lg",onClick:async()=>{var e;F();try{const a={video:{facingMode:g?"environment"===(null==(e=null==h?void 0:h.getVideoTracks()[0])?void 0:e.getSettings().facingMode)?"user":"environment":"user",width:{ideal:1280},height:{ideal:720}},audio:!1},s=await navigator.mediaDevices.getUserMedia(a);c.current&&(c.current.srcObject=s,c.current.play()),m(s),x(!0)}catch(a){S()}},className:"bg-white/20 border-white/30 text-white hover:bg-white/30",children:e.jsx(O,{className:"h-5 w-5"})}),e.jsx(t,{size:"lg",onClick:()=>{if(!c.current||!d.current)return;const e=c.current,a=d.current,s=a.getContext("2d");s&&(a.width=e.videoWidth,a.height=e.videoHeight,s.drawImage(e,0,0,a.width,a.height),a.toBlob(e=>{if(e){const e=a.toDataURL("image/jpeg",.8);p(e),F()}},"image/jpeg",.8))},disabled:!u,className:"bg-white text-black hover:bg-gray-100 rounded-full w-16 h-16 p-0",children:e.jsx("div",{className:"w-12 h-12 bg-white rounded-full border-4 border-gray-300"})}),e.jsx(t,{variant:"outline",size:"lg",onClick:D,className:"bg-white/20 border-white/30 text-white hover:bg-white/30",children:e.jsx(i,{className:"h-5 w-5"})})]})})})]})]})})},L=({currentPhoto:s,onPhotoSelect:r,onPhotoRemove:l,isLoading:n=!1,trigger:o})=>{const[c,d]=a.useState(!1),[h,m]=a.useState(null),[u,x]=a.useState(null),[v,p]=a.useState(!1),j=a.useRef(null),f=u||s;return e.jsxs(w,{open:c,onOpenChange:d,children:[e.jsx(P,{asChild:!0,children:o||e.jsx(t,{size:"sm",className:"absolute -bottom-2 -right-2 rounded-full w-8 h-8 p-0",children:e.jsx(z,{className:"w-4 h-4"})})}),e.jsxs(N,{className:"sm:max-w-md",children:[e.jsxs(b,{children:[e.jsx(y,{children:"Alterar Foto do Perfil"}),e.jsx(C,{children:"Escolha uma foto da câmera ou galeria para atualizar sua foto de perfil."})]}),e.jsxs("div",{className:"space-y-4",children:[f&&e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"relative mx-auto w-32 h-32 mb-4",children:[e.jsx("img",{src:f,alt:"Foto do perfil",className:"w-32 h-32 rounded-full object-cover border-4 border-gray-200"}),u&&e.jsx("div",{className:"absolute -top-2 -right-2",children:e.jsx(t,{size:"sm",variant:"destructive",className:"rounded-full w-6 h-6 p-0",onClick:()=>{m(null),x(null)},children:e.jsx(i,{className:"w-3 h-3"})})})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:u?"Nova foto selecionada":"Foto atual"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(t,{variant:"outline",onClick:()=>{p(!0)},className:"flex flex-col items-center gap-2 py-6",children:[e.jsx(z,{className:"w-6 h-6"}),e.jsx("span",{className:"text-sm",children:"Câmera"})]}),e.jsxs(t,{variant:"outline",onClick:()=>{var e;null==(e=j.current)||e.click()},className:"flex flex-col items-center gap-2 py-6",children:[e.jsx(E,{className:"w-6 h-6"}),e.jsx("span",{className:"text-sm",children:"Galeria"})]})]}),e.jsx("input",{ref:j,type:"file",accept:"image/*",onChange:e=>{var a;const s=null==(a=e.target.files)?void 0:a[0];if(s){m(s);const e=URL.createObjectURL(s);x(e)}},className:"hidden"}),e.jsx(T,{isOpen:v,onClose:()=>p(!1),onCapture:e=>{m(e);const a=URL.createObjectURL(e);x(a),p(!1)},isLoading:n}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[s&&l&&e.jsxs(t,{variant:"destructive",onClick:()=>{l&&(l(),d(!1))},className:"flex-1",children:[e.jsx(i,{className:"w-4 h-4 mr-2"}),"Remover"]}),e.jsx(t,{variant:"outline",onClick:()=>{m(null),x(null),d(!1)},className:"flex-1",children:"Cancelar"}),e.jsx(t,{onClick:()=>{h&&(r(h),d(!1),m(null),x(null))},disabled:!h||n,className:"flex-1",children:n?e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"w-4 h-4 mr-2 animate-spin"}),"Salvando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(F,{className:"w-4 h-4 mr-2"}),"Confirmar"]})})]})]})]})]})},$=()=>{const{user:s,refreshUserData:r}=l(),{toast:i}=n(),[F,E]=a.useState(!1),[O,T]=a.useState(!1),[$,M]=a.useState(!1),[U,R]=a.useState(!1),[I,A]=a.useState({currentPassword:"",newPassword:"",confirmPassword:""}),B=e=>{const a=(e||"").replace(/\D/g,"").slice(0,11);return a.length<=2?a?`(${a}`:"":a.length<=6?`(${a.slice(0,2)}) ${a.slice(2)}`:a.length<=10?`(${a.slice(0,2)}) ${a.slice(2,6)}-${a.slice(6)}`:`(${a.slice(0,2)}) ${a.slice(2,7)}-${a.slice(7,11)}`},[q,G]=a.useState({name:(null==s?void 0:s.name)||"",email:(null==s?void 0:s.email)||"",phone:B(null==s?void 0:s.phone),birthDate:((null==s?void 0:s.birthDate)&&/\d{4}-\d{2}-\d{2}/.test(s.birthDate)?s.birthDate.slice(0,10):"")||""});a.useEffect(()=>{G({name:(null==s?void 0:s.name)||"",email:(null==s?void 0:s.email)||"",phone:B(null==s?void 0:s.phone),birthDate:(e=>{if(!e)return"";if(/\d{4}-\d{2}-\d{2}/.test(e))return e.slice(0,10);try{return new Date(e).toISOString().slice(0,10)}catch{return""}})(null==s?void 0:s.birthDate)})},[s]),a.useEffect(()=>{null==r||r()},[r]);const J=()=>(null==s?void 0:s.profilePhoto)?s.profilePhoto.startsWith("http")?s.profilePhoto:`/uploads/${s.profilePhoto}`:null;return e.jsx(o,{children:e.jsxs("div",{className:"p-4 space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Meu Cadastro"}),e.jsx("p",{className:"text-muted-foreground",children:"Gerencie suas informações pessoais"})]}),e.jsx(c,{className:"shadow-divine",children:e.jsx(d,{className:"p-6",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsxs("div",{className:"relative mx-auto w-24 h-24",children:[(null==s?void 0:s.profilePhoto)?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:J()||"",alt:`Foto de ${s.name}`,className:"w-24 h-24 rounded-full object-cover border-4 border-primary/20",onError:e=>{const a=e.target;a.style.display="none";const s=a.nextElementSibling;s&&(s.style.display="flex")}}),e.jsx("div",{className:"w-24 h-24 rounded-full bg-gradient-primary flex items-center justify-center text-3xl font-bold text-primary-foreground",style:{display:"none"},children:null==s?void 0:s.name.charAt(0).toUpperCase()})]}):e.jsx("div",{className:"w-24 h-24 rounded-full bg-gradient-primary flex items-center justify-center text-3xl font-bold text-primary-foreground",children:null==s?void 0:s.name.charAt(0).toUpperCase()}),e.jsx(L,{currentPhoto:J(),onPhotoSelect:async e=>{if(null==s?void 0:s.id){T(!0);try{const a=new FormData;a.append("profilePhoto",e),a.append("userId",s.id.toString());const t=await fetch("/api/users/upload-photo",{method:"POST",body:a});if(!t.ok)throw new Error("Falha ao fazer upload da foto");await t.json();r&&await r(),i({title:"Foto atualizada!",description:"Sua foto de perfil foi atualizada com sucesso"})}catch(a){i({title:"Erro ao atualizar foto",description:"Não foi possível atualizar sua foto. Tente novamente.",variant:"destructive"})}finally{T(!1)}}},onPhotoRemove:async()=>{if(null==s?void 0:s.id)try{if(!(await fetch(`/api/users/${s.id}/remove-photo`,{method:"DELETE"})).ok)throw new Error("Falha ao remover foto");r&&await r(),i({title:"Foto removida!",description:"Sua foto de perfil foi removida com sucesso"})}catch(e){i({title:"Erro ao remover foto",description:"Não foi possível remover sua foto. Tente novamente.",variant:"destructive"})}},isLoading:O,trigger:e.jsx(t,{size:"sm",className:"absolute -bottom-2 -right-2 rounded-full w-8 h-8 p-0",disabled:O,children:O?e.jsx(k,{className:"w-4 h-4 animate-spin"}):e.jsx(z,{className:"w-4 h-4"})})})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:null==s?void 0:s.name}),e.jsx("p",{className:"text-muted-foreground capitalize",children:"admin"===(null==s?void 0:s.role)?"Administrador":"missionary"===(null==s?void 0:s.role)?"Missionário":"member"===(null==s?void 0:s.role)?"Membro":"Interessado"})]})]})})}),e.jsxs(c,{className:"shadow-divine",children:[e.jsxs(h,{className:"flex flex-row items-center justify-between space-y-0",children:[e.jsx(m,{children:"Informações Pessoais"}),F?e.jsxs("div",{className:"flex gap-2",children:[e.jsx(t,{onClick:()=>{G({name:(null==s?void 0:s.name)||"",email:(null==s?void 0:s.email)||"",phone:B(null==s?void 0:s.phone),birthDate:((null==s?void 0:s.birthDate)&&/\d{4}-\d{2}-\d{2}/.test(s.birthDate)?s.birthDate.slice(0,10):"")||""}),E(!1)},variant:"outline",size:"sm",children:"Cancelar"}),e.jsxs(t,{onClick:async()=>{if(null==s?void 0:s.id)try{if(!(await fetch(`/api/users/${s.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(q)})).ok)throw new Error("Falha ao atualizar dados");r&&await r(),E(!1),i({title:"Dados atualizados",description:"Suas informações foram salvas com sucesso"})}catch(e){i({title:"Erro ao salvar",description:"Não foi possível salvar suas informações. Tente novamente.",variant:"destructive"})}},size:"sm",children:[e.jsx(D,{className:"w-4 h-4 mr-2"}),"Salvar"]})]}):e.jsx(t,{onClick:()=>E(!0),size:"sm",children:"Editar"})]}),e.jsxs(d,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"name",children:"Nome completo"}),e.jsxs("div",{className:"relative",children:[e.jsx(x,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(v,{id:"name",value:q.name,onChange:e=>G(a=>({...a,name:e.target.value})),className:"pl-10",disabled:!F})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"email",children:"Email"}),e.jsxs("div",{className:"relative",children:[e.jsx(p,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(v,{id:"email",type:"email",value:q.email,onChange:e=>G(a=>({...a,email:e.target.value})),className:"pl-10",disabled:!F})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"phone",children:"Telefone"}),e.jsxs("div",{className:"relative",children:[e.jsx(j,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(v,{id:"phone",value:q.phone,onChange:e=>G(a=>({...a,phone:B(e.target.value)})),className:"pl-10",disabled:!F})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"birthDate",children:"Data de nascimento"}),e.jsxs("div",{className:"relative",children:[e.jsx(f,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(v,{id:"birthDate",type:"date",value:q.birthDate,onChange:e=>G(a=>({...a,birthDate:e.target.value})),className:"pl-10",disabled:!F})]})]})]})]}),e.jsxs(c,{className:"shadow-divine",children:[e.jsx(h,{children:e.jsx(m,{children:"Segurança"})}),e.jsx(d,{children:e.jsxs(w,{open:$,onOpenChange:M,children:[e.jsx(P,{asChild:!0,children:e.jsxs(t,{variant:"outline",className:"w-full",children:[e.jsx(g,{className:"w-4 h-4 mr-2"}),"Alterar Senha"]})}),e.jsxs(N,{children:[e.jsxs(b,{children:[e.jsx(y,{children:"Alterar senha"}),e.jsx(C,{children:"Informe sua senha atual e defina uma nova senha."})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"currentPassword",children:"Senha atual"}),e.jsx(v,{id:"currentPassword",type:"password",value:I.currentPassword,onChange:e=>A(a=>({...a,currentPassword:e.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"newPassword",children:"Nova senha"}),e.jsx(v,{id:"newPassword",type:"password",value:I.newPassword,onChange:e=>A(a=>({...a,newPassword:e.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"confirmPassword",children:"Confirmar nova senha"}),e.jsx(v,{id:"confirmPassword",type:"password",value:I.confirmPassword,onChange:e=>A(a=>({...a,confirmPassword:e.target.value}))})]})]}),e.jsxs(S,{children:[e.jsx(t,{variant:"outline",onClick:()=>M(!1),disabled:U,children:"Cancelar"}),e.jsxs(t,{onClick:async()=>{if((null==s?void 0:s.id)&&(I.currentPassword&&I.newPassword&&I.confirmPassword?I.newPassword.length<6?(i({title:"Senha muito curta",description:"A nova senha deve ter pelo menos 6 caracteres.",variant:"destructive"}),0):I.newPassword===I.confirmPassword||(i({title:"Confirmação incorreta",description:"A confirmação deve coincidir com a nova senha.",variant:"destructive"}),0):(i({title:"Campos obrigatórios",description:"Preencha todas as senhas.",variant:"destructive"}),0)))try{R(!0);const e=await fetch("/api/auth/change-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:Number(s.id),currentPassword:I.currentPassword,newPassword:I.newPassword})}),a=await e.json().catch(()=>({}));if(!e.ok||!1===(null==a?void 0:a.success)){const e=(null==a?void 0:a.message)||"Falha ao alterar a senha";return void i({title:"Erro ao alterar senha",description:e,variant:"destructive"})}await(null==r?void 0:r()),M(!1),A({currentPassword:"",newPassword:"",confirmPassword:""}),i({title:"Senha alterada",description:"Sua senha foi atualizada com sucesso."})}catch(e){i({title:"Erro ao alterar senha",description:"Tente novamente.",variant:"destructive"})}finally{R(!1)}},disabled:U,children:[U?e.jsx(k,{className:"w-4 h-4 mr-2 animate-spin"}):null,"Salvar nova senha"]})]})]})]})})]})]})})};
/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */export{$ as default};
