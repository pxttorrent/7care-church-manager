// ========== DIAGNÃ“STICO COMPLETO - Cole no Console (F12) ==========

(async function diagnosticoCompleto() {
  console.clear();
  console.log('%cğŸ” DIAGNÃ“STICO OFFLINE SYNC v28', 'font-size: 20px; font-weight: bold; color: #667eea;');
  console.log('%câ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color: #667eea;');
  
  // 1. Verificar Service Worker
  console.log('\n%c1ï¸âƒ£ SERVICE WORKER STATUS', 'font-size: 16px; font-weight: bold; color: #333;');
  console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  
  const reg = await navigator.serviceWorker.getRegistration();
  if (reg) {
    console.log('âœ… SW Registrado:', {
      ativo: !!reg.active,
      waiting: !!reg.waiting,
      installing: !!reg.installing,
      controlador: !!navigator.serviceWorker.controller
    });
  } else {
    console.log('âŒ NENHUM SW REGISTRADO!');
    return;
  }
  
  // 2. Verificar Caches
  console.log('\n%c2ï¸âƒ£ CACHES', 'font-size: 16px; font-weight: bold; color: #333;');
  console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  
  const cacheNames = await caches.keys();
  console.log('Caches encontrados:', cacheNames);
  const hasV28 = cacheNames.some(c => c.includes('v28'));
  console.log(hasV28 ? 'âœ… Cache v28 EXISTE' : 'âŒ Cache v28 NÃƒO existe (ainda v27 ou nada)');
  
  // 3. Verificar IndexedDB
  console.log('\n%c3ï¸âƒ£ INDEXEDDB', 'font-size: 16px; font-weight: bold; color: #333;');
  console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  
  const dbs = await indexedDB.databases();
  console.log('Databases:', dbs.map(d => d.name));
  
  if (dbs.some(d => d.name === '7care-sync-db')) {
    const db = await new Promise((resolve) => {
      const req = indexedDB.open('7care-sync-db', 2);
      req.onsuccess = () => resolve(req.result);
    });
    
    console.log('Database: 7care-sync-db v' + db.version);
    console.log('Stores:', Array.from(db.objectStoreNames));
    
    if (db.objectStoreNames.contains('sync-queue')) {
      const tx = db.transaction(['sync-queue'], 'readonly');
      const store = tx.objectStore('sync-queue');
      const items = await new Promise(r => { const req = store.getAll(); req.onsuccess = () => r(req.result); });
      console.log('âœ… Sync Queue:', items.length, 'itens');
    } else {
      console.log('âŒ sync-queue NÃƒO EXISTE');
    }
    
    if (db.objectStoreNames.contains('local-data')) {
      const tx = db.transaction(['local-data'], 'readonly');
      const store = tx.objectStore('local-data');
      const items = await new Promise(r => { const req = store.getAll(); req.onsuccess = () => r(req.result); });
      console.log('âœ… Local Data:', items.length, 'itens');
      if (items.length > 0) {
        console.log('   Itens:', items.map(i => i.data.title));
      }
    } else {
      console.log('âŒ local-data NÃƒO EXISTE!');
      console.log('ğŸ’¡ PROBLEMA: SW v28 nÃ£o criou o store local-data');
      console.log('ğŸ’¡ SOLUÃ‡ÃƒO: Precisa forÃ§ar atualizaÃ§Ã£o do SW');
    }
  } else {
    console.log('âŒ Database 7care-sync-db NÃƒO EXISTE!');
  }
  
  // 4. TESTE: Simular criaÃ§Ã£o offline
  console.log('\n%c4ï¸âƒ£ TESTE: CRIAR EVENTO OFFLINE', 'font-size: 16px; font-weight: bold; color: #333;');
  console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  console.log('Enviando POST /api/events...');
  
  try {
    const response = await fetch('/api/events', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title: 'TESTE DIAGNÃ“STICO ' + Date.now(),
        date: new Date().toISOString(),
        location: 'Teste',
        type: 'ReuniÃ£o',
        description: 'Teste de criaÃ§Ã£o'
      })
    });
    
    const data = await response.json();
    
    console.log('Status:', response.status);
    console.log('Headers:', {
      'X-Offline-Created': response.headers.get('X-Offline-Created'),
      'X-Pending-Sync': response.headers.get('X-Pending-Sync')
    });
    console.log('Resposta:', data);
    
    if (data._offlineCreated) {
      console.log('âœ… Criado OFFLINE com sucesso!');
      console.log('ID temporÃ¡rio:', data.id);
      
      // Verificar se salvou no IndexedDB
      console.log('\nVerificando se salvou...');
      setTimeout(async () => {
        const db = await new Promise((resolve) => {
          const req = indexedDB.open('7care-sync-db', 2);
          req.onsuccess = () => resolve(req.result);
        });
        
        if (db.objectStoreNames.contains('local-data')) {
          const tx = db.transaction(['local-data'], 'readonly');
          const store = tx.objectStore('local-data');
          const items = await new Promise(r => { const req = store.getAll(); req.onsuccess = () => r(req.result); });
          console.log('ğŸ’¾ Local Data AGORA:', items.length, 'itens');
          if (items.length > 0) {
            console.log('%câœ… EVENTO SALVO NO LOCAL DATA!', 'color: green; font-weight: bold;');
          } else {
            console.log('%câŒ EVENTO NÃƒO FOI SALVO!', 'color: red; font-weight: bold;');
          }
        }
      }, 500);
      
    } else {
      console.log('â„¹ï¸ Criado ONLINE (vocÃª estÃ¡ conectado)');
    }
    
  } catch (error) {
    console.error('âŒ Erro ao criar:', error);
  }
  
  // 5. CONCLUSÃƒO
  console.log('\n%câ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color: #667eea;');
  console.log('%cğŸ“Š DIAGNÃ“STICO COMPLETO!', 'font-size: 16px; font-weight: bold; color: #667eea;');
  console.log('\nVerifique os resultados acima.');
  console.log('Se encontrou problemas, me envie os logs!');
  
})();
